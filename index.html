import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken,
  GoogleAuthProvider,
  signInWithPopup
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  onSnapshot,
  writeBatch,
  getDocs,
  query
} from 'firebase/firestore';
import { 
  User, 
  Star, 
  CheckCircle, 
  Send, 
  Vote, 
  Database,
  Loader2,
  AlertCircle,
  XCircle,
  Check,
  Settings,
  Plus,
  Trash2,
  ChevronLeft,
  ClipboardList,
  Edit3,
  Heart,
  GripHorizontal,
  Users,
  BarChart3,
  ClipboardCheck,
  Filter
} from 'lucide-react';

// --- Firebase 初始化 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const TEACHER_EMAIL = "susi@st.tc.edu.tw";

// --- 常數定義 ---
const RATING_OPTIONS = [
  { val: -1, score: "-1", label: "表現不好，邊做邊玩", color: "bg-[#FFB7B2]", activeColor: "bg-[#FF8B8B]", border: "border-[#FFB7B2]", textColor: "text-rose-900" },
  { val: 0, score: "+0", label: "被動、要做不做", color: "bg-[#FFDAC1]", activeColor: "bg-[#FFC49F]", border: "border-[#FFDAC1]", textColor: "text-orange-900" },
  { val: 1, score: "+1", label: "偶爾做，比沒做還好", color: "bg-[#FFF9C4]", activeColor: "bg-[#FFF176]", border: "border-[#FFF9C4]", textColor: "text-yellow-900" },
  { val: 2, score: "+2", label: "常常做，大部分完成", color: "bg-[#B5EAD7]", activeColor: "bg-[#8DE2C1]", border: "border-[#B5EAD7]", textColor: "text-emerald-900" },
  { val: 3, score: "+3", label: "主動積極，按時完成", color: "bg-[#C7CEEA]", activeColor: "bg-[#A2B2FC]", border: "border-[#C7CEEA]", textColor: "text-indigo-900" }
];

// --- 元件：主應用程式 ---
export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [userData, setUserData] = useState(null); 
  const [step, setStep] = useState('login'); // login, eval, pref, waiting, admin
  
  // 彈窗狀態
  const [modal, setModal] = useState({ show: false, title: '', message: '', type: 'info', onConfirm: null });
  const [isActionLoading, setIsActionLoading] = useState(false);

  // 資料庫狀態
  const [officers, setOfficers] = useState([]);
  const [userResponse, setUserResponse] = useState({ evaluations: {}, preferences: Array(16).fill(null) });
  const [allStudentResponses, setAllStudentResponses] = useState([]); // 教師端使用
  const [allStudentProfiles, setAllStudentProfiles] = useState([]); // 教師端使用

  // 管理員狀態
  const [adminTab, setAdminTab] = useState('list'); // list, progress, ratings, volunteers
  const [editList, setEditList] = useState([]);
  const [isAdminMode, setIsAdminMode] = useState('manual');
  const [pasteContent, setPasteContent] = useState('');
  const [topNLimit, setTopNLimit] = useState(5); // 志願統計呈現前 N

  // 待選區職務
  const [availableRoles, setAvailableRoles] = useState([]);
  const [draggedItem, setDraggedItem] = useState(null);

  // 初始化 Auth
  useEffect(() => {
    let mounted = true;
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) { console.error(error); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      if (!mounted) return;
      setUser(currentUser);
      setLoading(false);
    });
    return () => { mounted = false; unsubscribe(); };
  }, []);

  // 監聽公共資料 (現任幹部)
  useEffect(() => {
    if (!user) return;
    const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'officers'), (snapshot) => {
      const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      data.sort((a, b) => Number(a.seatNo) - Number(b.seatNo));
      setOfficers(data);
      if (editList.length === 0) setEditList(data);

      const uniqueRoles = [...new Set(data.map(o => o.role.replace(/\d+$/, '')))];
      const currentPrefs = userResponse.preferences || [];
      setAvailableRoles(uniqueRoles.filter(r => !currentPrefs.includes(r)));
    });
    return () => unsub();
  }, [user, userResponse.preferences]);

  // 監聽教師端全班資料 (僅限教師 Email)
  useEffect(() => {
    if (!user || user.email !== TEACHER_EMAIL) return;

    // 監聽全班回應 (為了教師進度與統計頁面)
    const unsubResponses = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'responses_summary'), (snap) => {
      setAllStudentResponses(snap.docs.map(d => ({ uid: d.id, ...d.data() })));
    });

    return () => { unsubResponses(); };
  }, [user]);

  // 監聽使用者個人資料
  useEffect(() => {
    if (!user) return;
    const unsubUser = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), (docSnap) => {
      if (docSnap.exists()) {
        setUserData(docSnap.data());
        if (step === 'login') setStep('eval');
      }
    });

    const unsubResp = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'responses'), (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        const savedPrefs = data.preferences || Array(16).fill(null);
        setUserResponse(prev => ({
          ...prev,
          ...data,
          preferences: [...savedPrefs, ...Array(16).fill(null)].slice(0, 16),
          evaluations: data.evaluations || {}
        }));
      }
    });
    return () => { unsubUser(); unsubResp(); };
  }, [user, step]);

  // --- 統計邏輯 (教師端) ---
  const ratingStats = useMemo(() => {
    const stats = {};
    officers.forEach(off => {
      stats[off.id] = { name: off.name, role: off.role, counts: { "-1": 0, "0": 0, "1": 0, "2": 0, "3": 0 } };
    });

    allStudentResponses.forEach(resp => {
      const evals = resp.evaluations || {};
      Object.entries(evals).forEach(([offId, score]) => {
        if (stats[offId]) stats[offId].counts[String(score)]++;
      });
    });
    return stats;
  }, [allStudentResponses, officers]);

  const volunteerStats = useMemo(() => {
    const stats = {};
    // 取得不重複職務
    const uniqueRoles = [...new Set(officers.map(o => o.role.replace(/\d+$/, '')))];
    uniqueRoles.forEach(role => stats[role] = []);

    allStudentResponses.forEach(resp => {
      const prefs = resp.preferences || [];
      prefs.forEach((role, idx) => {
        if (role && stats[role] !== undefined) {
          stats[role].push({ name: resp.name, seatNo: resp.seatNo, rank: idx + 1 });
        }
      });
    });
    return stats;
  }, [allStudentResponses, officers]);

  // --- 輔助函式 ---
  const showMessage = (title, message, type = 'info', onConfirm = null) => {
    setModal({ show: true, title, message: String(message), type, onConfirm });
  };

  const closeModal = () => setModal(prev => ({ ...prev, show: false }));

  const enterAdmin = async () => {
    if (!user) return;
    
    // 如果是匿名登入或非指定信箱，則觸發 Google 登入
    if (!user.email) {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        if (result.user.email !== TEACHER_EMAIL) {
          showMessage("拒絕存取", `抱歉，只有 ${TEACHER_EMAIL} 擁有管理權限。`, "error");
          return;
        }
      } catch (e) {
        return;
      }
    } else if (user.email !== TEACHER_EMAIL) {
      showMessage("權限不足", "您的帳號並非教師管理帳號。", "error");
      return;
    }
    setStep('admin');
  };

  // --- 儲存邏輯 (增加公共同步) ---
  const syncResponseToPublic = async (data) => {
    if (!user || !userData) return;
    // 為了讓教師看到，將精簡資料存入公共區域
    const summaryRef = doc(db, 'artifacts', appId, 'public', 'data', 'responses_summary', user.uid);
    await setDoc(summaryRef, {
      seatNo: userData.seatNo,
      name: userData.name,
      evaluations: data.evaluations || {},
      preferences: data.preferences || [],
      lastUpdated: new Date().toISOString()
    });
  };

  const saveToDB = async () => {
    setIsActionLoading(true);
    closeModal();
    try {
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'responses'), userResponse, { merge: true });
      await syncResponseToPublic(userResponse);
      setStep('waiting');
    } catch (error) {
      showMessage("錯誤", "儲存失敗", "error");
    } finally { setIsActionLoading(false); }
  };

  const submitEvaluations = async () => {
    const ratedIds = Object.keys(userResponse.evaluations || {});
    if (officers.filter(off => !ratedIds.includes(off.id)).length > 0) {
      showMessage("小提醒", "還有幹部沒評到分喔！", "warning");
      return;
    }
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'responses'), userResponse, { merge: true });
    await syncResponseToPublic(userResponse);
    setStep('pref');
  };

  // --- 拖曳與登入 ---
  const handleDragStart = (e, type, value, index) => { setDraggedItem({ type, value, index }); };
  const handleDrop = (e, targetType, targetIndex) => {
    e.preventDefault();
    if (!draggedItem) return;
    const newPrefs = [...userResponse.preferences];
    if (targetType === 'slot') {
      const oldValue = newPrefs[targetIndex];
      if (draggedItem.type === 'pool') { newPrefs[targetIndex] = draggedItem.value; }
      else { newPrefs[draggedItem.index] = oldValue; newPrefs[targetIndex] = draggedItem.value; }
    } else if (targetType === 'pool' && draggedItem.type === 'slot') { newPrefs[draggedItem.index] = null; }
    setUserResponse({ ...userResponse, preferences: newPrefs });
    setDraggedItem(null);
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const seatNo = formData.get('seatNo');
    const name = formData.get('name');
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), { seatNo, name, uid: user.uid });
  };

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-[#FFFAF0]"><Loader2 className="animate-spin text-[#A2B2FC] h-12 w-12" /></div>;

  return (
    <div className="min-h-screen bg-[#FFFAF0] text-slate-700 font-sans pb-10 selection:bg-[#C7CEEA]">
      
      {/* 可愛彈窗 */}
      {modal.show && (
        <div className="fixed inset-0 bg-white/40 backdrop-blur-md flex items-center justify-center z-[100] p-4">
          <div className="bg-white rounded-[3rem] shadow-2xl max-w-sm w-full border-4 border-white">
            <div className="p-8 text-center">
              <div className="flex justify-center mb-4">
                {modal.type === 'error' ? <XCircle className="text-[#FFB7B2] h-16 w-16" /> : <Heart className="text-[#C7CEEA] h-16 w-16 fill-[#C7CEEA]" />}
              </div>
              <h3 className="text-2xl font-black mb-2">{modal.title}</h3>
              <p className="text-slate-500 font-bold">{modal.message}</p>
            </div>
            <div className="p-6 pt-0 flex gap-3">
              {modal.onConfirm ? (
                <>
                  <button onClick={closeModal} className="flex-1 py-4 bg-slate-100 text-slate-400 font-black rounded-3xl">取消</button>
                  <button onClick={modal.onConfirm} className="flex-1 py-4 bg-[#B5EAD7] text-emerald-800 font-black rounded-3xl">是的！</button>
                </>
              ) : (
                <button onClick={closeModal} className="w-full py-4 bg-[#C7CEEA] text-white font-black rounded-3xl shadow-lg">知道了</button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Header */}
      <header className="bg-white/70 backdrop-blur-md p-6 sticky top-0 z-10 border-b border-white">
        <div className="max-w-5xl mx-auto flex justify-between items-center">
          <h1 className="text-xl sm:text-2xl font-black text-[#8799E8] flex items-center gap-2">
            <Heart className="h-6 w-6 fill-[#FFB7B2] text-[#FFB7B2]" /> 班級幹部系統
          </h1>
          {userData && step !== 'admin' && <div className="bg-[#E2F0CB] text-lime-800 px-5 py-2 rounded-full font-black text-sm border-2 border-white">{userData.seatNo} 號 {userData.name}</div>}
        </div>
      </header>

      <main className="max-w-5xl mx-auto p-4 mt-4">
        
        {/* 1. 登入頁面 */}
        {step === 'login' && (
          <div className="bg-white p-10 rounded-[4rem] shadow-sm border-4 border-white max-w-md mx-auto mt-10">
            <h2 className="text-3xl font-black text-slate-800 text-center mb-8">學生登入</h2>
            <form onSubmit={handleLogin} className="space-y-6">
              <input type="number" name="seatNo" required className="w-full bg-[#FFFAF0] rounded-[2rem] p-5 font-black text-xl text-center outline-none border-4 border-transparent focus:border-[#C7CEEA]" placeholder="座號" />
              <input type="text" name="name" required className="w-full bg-[#FFFAF0] rounded-[2rem] p-5 font-black text-xl text-center outline-none border-4 border-transparent focus:border-[#FFDAC1]" placeholder="姓名" />
              <button type="submit" className="w-full bg-[#C7CEEA] text-white font-black py-6 rounded-[2rem] shadow-xl text-lg">開始填答</button>
            </form>
            <button onClick={enterAdmin} className="mt-8 text-[10px] font-black text-slate-300 block mx-auto underline tracking-widest uppercase flex items-center gap-1 hover:text-[#8799E8]">
              <Settings className="w-3 h-3" /> 教師端管理
            </button>
          </div>
        )}

        {/* 2. 教師管理頁面 */}
        {step === 'admin' && (
          <div className="space-y-6 animate-in fade-in">
            {/* 管理分頁切換 */}
            <div className="flex flex-wrap gap-2 mb-2">
              <button onClick={() => setAdminTab('list')} className={`px-6 py-3 rounded-2xl font-black text-sm flex items-center gap-2 transition ${adminTab === 'list' ? 'bg-[#C7CEEA] text-white' : 'bg-white text-slate-400'}`}><Database className="w-4 h-4" /> 名單設定</button>
              <button onClick={() => setAdminTab('progress')} className={`px-6 py-3 rounded-2xl font-black text-sm flex items-center gap-2 transition ${adminTab === 'progress' ? 'bg-[#FFDAC1] text-orange-800' : 'bg-white text-slate-400'}`}><ClipboardCheck className="w-4 h-4" /> 填答進度</button>
              <button onClick={() => setAdminTab('ratings')} className={`px-6 py-3 rounded-2xl font-black text-sm flex items-center gap-2 transition ${adminTab === 'ratings' ? 'bg-[#FFB7B2] text-rose-800' : 'bg-white text-slate-400'}`}><BarChart3 className="w-4 h-4" /> 評分結果</button>
              <button onClick={() => setAdminTab('volunteers')} className={`px-6 py-3 rounded-2xl font-black text-sm flex items-center gap-2 transition ${adminTab === 'volunteers' ? 'bg-[#E2F0CB] text-lime-800' : 'bg-white text-slate-400'}`}><Users className="w-4 h-4" /> 志願統計</button>
              <button onClick={() => setStep('login')} className="ml-auto px-6 py-3 rounded-2xl font-black text-sm bg-slate-100 text-slate-500 hover:bg-slate-200">登出</button>
            </div>

            <div className="bg-white p-8 rounded-[3.5rem] border-4 border-white shadow-sm">
              {/* 分頁 1: 名單設定 */}
              {adminTab === 'list' && (
                <div>
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-2xl font-black">現任幹部清單</h3>
                    <div className="flex bg-slate-100 p-1 rounded-xl">
                      <button onClick={() => setIsAdminMode('manual')} className={`px-4 py-2 rounded-lg text-xs font-bold ${isAdminMode === 'manual' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>手動</button>
                      <button onClick={() => setIsAdminMode('paste')} className={`px-4 py-2 rounded-lg text-xs font-bold ${isAdminMode === 'paste' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>批次</button>
                    </div>
                  </div>
                  {isAdminMode === 'paste' ? (
                    <textarea value={pasteContent} onChange={(e) => setPasteContent(e.target.value)} className="w-full h-40 bg-[#FFFAF0] rounded-3xl p-4 font-bold outline-none mb-4" placeholder="座號 [Tab] 職務 [Tab] 姓名" />
                  ) : (
                    <div className="space-y-2 mb-4">
                      {editList.map((row, idx) => (
                        <div key={idx} className="flex gap-2 items-center">
                          <input type="number" value={row.seatNo} onChange={(e) => { const n = [...editList]; n[idx].seatNo = e.target.value; setEditList(n); }} className="w-16 p-2 bg-slate-50 rounded-xl font-bold text-center" />
                          <input type="text" value={row.role} onChange={(e) => { const n = [...editList]; n[idx].role = e.target.value; setEditList(n); }} className="flex-1 p-2 bg-slate-50 rounded-xl font-bold" />
                          <input type="text" value={row.name} onChange={(e) => { const n = [...editList]; n[idx].name = e.target.value; setEditList(n); }} className="flex-1 p-2 bg-slate-50 rounded-xl font-bold" />
                          <button onClick={() => setEditList(editList.filter((_, i) => i !== idx))}><Trash2 className="w-4 h-4 text-rose-300" /></button>
                        </div>
                      ))}
                      <button onClick={() => setEditList([...editList, { seatNo: '', role: '', name: '' }])} className="text-xs font-bold text-indigo-400">+ 新增一行</button>
                    </div>
                  )}
                  <div className="flex gap-4">
                    {isAdminMode === 'paste' ? <button onClick={() => { const lines = pasteContent.split('\n').filter(l => l.trim()); setEditList(lines.map(l => { const p = l.split('\t'); return { seatNo: p[0], role: p[1], name: p[2] }; })); setIsAdminMode('manual'); }} className="flex-1 bg-[#C7CEEA] text-white py-4 rounded-3xl font-black">解析資料</button> : null}
                    <button onClick={async () => { const batch = writeBatch(db); const col = collection(db, 'artifacts', appId, 'public', 'data', 'officers'); const snap = await getDocs(col); snap.docs.forEach(d => batch.delete(d.ref)); editList.forEach((o, i) => batch.set(doc(col), { ...o, sortId: i + 1 })); await batch.commit(); showMessage("成功", "資料已更新！"); }} className="flex-1 bg-[#B5EAD7] text-emerald-800 py-4 rounded-3xl font-black">儲存至雲端</button>
                  </div>
                </div>
              )}

              {/* 分頁 2: 填答進度 */}
              {adminTab === 'progress' && (
                <div>
                  <h3 className="text-2xl font-black mb-6">全班填答進度</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full text-left">
                      <thead>
                        <tr className="text-slate-400 text-xs font-black uppercase tracking-widest border-b-2 border-slate-50">
                          <th className="pb-4 pl-4">座號</th>
                          <th className="pb-4">姓名</th>
                          <th className="pb-4">幹部評分</th>
                          <th className="pb-4">志願排序</th>
                          <th className="pb-4">最後更新</th>
                        </tr>
                      </thead>
                      <tbody className="font-bold">
                        {allStudentResponses.sort((a,b) => Number(a.seatNo) - Number(b.seatNo)).map(resp => {
                          const hasEval = Object.keys(resp.evaluations || {}).length >= officers.length;
                          const hasPref = (resp.preferences || []).filter(p => p).length >= 5;
                          return (
                            <tr key={resp.uid} className="border-b border-slate-50 hover:bg-slate-50 transition">
                              <td className="py-4 pl-4">{resp.seatNo}</td>
                              <td>{resp.name}</td>
                              <td>{hasEval ? <span className="text-emerald-500">已完成</span> : <span className="text-rose-300">未完成 ({Object.keys(resp.evaluations || {}).length})</span>}</td>
                              <td>{hasPref ? <span className="text-emerald-500">已排序</span> : <span className="text-rose-300">未完成 ({(resp.preferences || []).filter(p => p).length})</span>}</td>
                              <td className="text-[10px] text-slate-300 font-medium">{new Date(resp.lastUpdated).toLocaleString()}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* 分頁 3: 評分統計 */}
              {adminTab === 'ratings' && (
                <div className="space-y-6">
                  <h3 className="text-2xl font-black mb-4">現任幹部評分結果 (得票數)</h3>
                  {officers.map(off => {
                    const stats = ratingStats[off.id]?.counts || {};
                    const total = Object.values(stats).reduce((a, b) => a + b, 0);
                    return (
                      <div key={off.id} className="bg-[#FFFAF0] p-6 rounded-[2.5rem] border-2 border-white shadow-sm">
                        <div className="flex items-center gap-3 mb-4">
                          <span className="bg-[#C7CEEA] text-white text-[10px] font-black px-3 py-1 rounded-lg">{off.role}</span>
                          <span className="text-xl font-black">{off.name}</span>
                          <span className="text-slate-300 text-xs ml-auto">共 {total} 人評分</span>
                        </div>
                        <div className="grid grid-cols-5 gap-2">
                          {RATING_OPTIONS.map(opt => (
                            <div key={opt.val} className={`p-3 rounded-2xl border-2 border-white flex flex-col items-center ${opt.color}`}>
                              <span className="text-xs font-black mb-1">{opt.score}</span>
                              <span className="text-lg font-black">{stats[String(opt.val)] || 0}</span>
                              <span className="text-[8px] font-bold text-center opacity-60">票</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* 分頁 4: 志願統計 */}
              {adminTab === 'volunteers' && (
                <div>
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h3 className="text-2xl font-black">幹部職務志願統計</h3>
                    <div className="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-2xl border-2 border-white">
                      <Filter className="w-4 h-4 text-indigo-300" />
                      <span className="text-xs font-black text-slate-400">顯示前</span>
                      <select value={topNLimit} onChange={(e) => setTopNLimit(Number(e.target.value))} className="bg-transparent font-black text-indigo-600 outline-none">
                        {[1, 2, 3, 5, 10, 16].map(n => <option key={n} value={n}>{n}</option>)}
                      </select>
                      <span className="text-xs font-black text-slate-400">志願的人</span>
                    </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {Object.entries(volunteerStats).map(([role, students]) => {
                      const filtered = students.filter(s => s.rank <= topNLimit).sort((a,b) => a.rank - b.rank);
                      return (
                        <div key={role} className="bg-slate-50/50 p-6 rounded-[2.5rem] border-2 border-white">
                          <h4 className="text-lg font-black text-indigo-400 mb-4 flex items-center justify-between">
                            {role} <span className="text-xs bg-white px-3 py-1 rounded-full text-slate-300 shadow-sm">{filtered.length} 人</span>
                          </h4>
                          <div className="space-y-2">
                            {filtered.length === 0 ? <p className="text-slate-300 text-xs font-bold italic py-4">目前無人選擇此範圍</p> : filtered.map((s, i) => (
                              <div key={i} className="flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm border-2 border-[#E2F0CB]/30">
                                <div className="flex items-center gap-3">
                                  <span className="w-6 h-6 bg-slate-100 rounded-full flex items-center justify-center text-[10px] font-black text-slate-400">{s.seatNo}</span>
                                  <span className="font-black text-slate-600">{s.name}</span>
                                </div>
                                <span className="bg-[#FFF9C4] text-yellow-800 text-[10px] font-black px-3 py-1 rounded-full">第 {s.rank} 志願</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* 3. 幹部評分頁面 (學生) */}
        {step === 'eval' && (
          <div className="animate-in fade-in slide-in-from-bottom-6">
            <div className="bg-white p-8 rounded-[3.5rem] border-4 border-white mb-8">
              <h2 className="text-2xl font-black mb-8 flex items-center gap-2">現任幹部評分 <Star className="fill-yellow-400 text-yellow-400" /></h2>
              <div className="space-y-12">
                {officers.map(off => (
                  <div key={off.id} className="pb-8 border-b-2 border-slate-50 last:border-0">
                    <div className="flex items-center gap-3 mb-6 ml-2">
                      <span className="bg-[#C7CEEA] text-indigo-800 text-[10px] font-black px-4 py-1 rounded-full">{off.role}</span>
                      <span className="text-[#FFB7B2] font-black text-sm">#{off.seatNo}</span>
                      <span className="font-black text-2xl text-slate-700">{off.name}</span>
                    </div>
                    <div className="grid grid-cols-5 gap-2 px-2">
                      {RATING_OPTIONS.map(opt => {
                        const isSelected = userResponse.evaluations?.[off.id] === opt.val;
                        return (
                          <button key={opt.val} onClick={() => setUserResponse({...userResponse, evaluations: {...userResponse.evaluations, [off.id]: opt.val}})} 
                                  className={`flex flex-col items-center justify-center py-4 px-1 rounded-3xl border-2 transition-all duration-200 ${isSelected ? `${opt.activeColor} ${opt.textColor} border-white shadow-lg -translate-y-1 scale-105` : `bg-white ${opt.textColor} ${opt.border} opacity-40 hover:opacity-100`}`}>
                            <span className="text-lg font-black mb-1">{opt.score}</span>
                            <span className="text-[10px] font-bold text-center leading-tight h-8 flex items-center justify-center">{opt.label}</span>
                          </button>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </div>
            <button onClick={submitEvaluations} className="float-right bg-[#B5EAD7] text-emerald-800 font-black py-5 px-14 rounded-full shadow-xl border-4 border-white mb-10">下一步</button>
          </div>
        )}

        {/* 4. 志願排序頁面 (學生) */}
        {step === 'pref' && (
          <div className="animate-in fade-in slide-in-from-bottom-6">
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
              <div className="lg:col-span-4 bg-white p-6 rounded-[3rem] border-4 border-white lg:sticky lg:top-28">
                <h3 className="text-lg font-black text-[#8799E8] mb-4">待選職務</h3>
                <div className="flex flex-wrap gap-2 p-4 bg-[#FFFAF0] rounded-2xl min-h-[150px]" onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, 'pool')}>
                  {availableRoles.length === 0 && <div className="text-slate-300 font-bold text-center w-full mt-6 italic">已全選</div>}
                  {availableRoles.map(r => <div key={r} draggable onDragStart={(e) => handleDragStart(e, 'pool', r)} className="bg-white border-4 border-[#C7CEEA] px-4 py-2 rounded-2xl font-black text-sm text-[#8799E8] cursor-grab active:scale-95 shadow-sm flex items-center gap-2"><GripHorizontal className="w-3 h-3 opacity-30" /> {r}</div>)}
                </div>
              </div>
              <div className="lg:col-span-8 bg-white p-8 rounded-[3.5rem] border-4 border-white">
                <h3 className="text-xl font-black mb-6">志願排序 (前5名為必填)</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {userResponse.preferences.map((p, i) => (
                    <div key={i} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, 'slot', i)} className={`flex items-center gap-4 p-4 rounded-3xl border-4 transition-all ${i < 5 ? 'bg-[#E2F0CB]/30 border-[#E2F0CB]' : 'bg-[#FFFAF0] border-white'}`}>
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center font-black text-white shrink-0 shadow-sm ${i < 5 ? 'bg-[#B5EAD7]' : 'bg-[#C7CEEA]'}`}>{i + 1}</div>
                      <div className="flex-1 min-h-[48px] flex items-center">
                        {p ? <div draggable onDragStart={(e) => handleDragStart(e, 'slot', p, i)} className="bg-white border-4 border-[#C7CEEA] px-5 py-2.5 rounded-2xl font-black text-lg text-[#8799E8] cursor-grab shadow-sm w-full flex justify-between items-center"><span>{p}</span><GripHorizontal className="w-4 h-4 opacity-20" /></div> : <span className="text-slate-200 font-bold italic ml-2">尚未填入</span>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            <div className="flex justify-between mt-10 mb-20">
              <button onClick={() => setStep('eval')} className="text-[#C7CEEA] font-black underline">← 修改評分</button>
              <button onClick={handleFinalSubmit} className="bg-[#B5EAD7] text-emerald-800 font-black py-5 px-14 rounded-full shadow-xl border-4 border-white">選好了，送出！</button>
            </div>
          </div>
        )}

        {/* 5. 填寫完成頁面 */}
        {step === 'waiting' && (
          <div className="text-center pt-10 animate-in zoom-in">
            <div className="bg-white p-20 rounded-[5rem] shadow-xl border-4 border-white max-w-lg mx-auto">
              <h2 className="text-4xl font-black text-slate-800 mb-6">填寫成功！</h2>
              <p className="text-slate-400 font-bold mb-10">你的心聲已儲存，請靜候票選結果。</p>
              <button onClick={() => setStep('eval')} className="text-[#C7CEEA] font-black underline">返回修改內容</button>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}